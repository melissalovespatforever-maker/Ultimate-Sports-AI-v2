<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment System Diagnostics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .status-label {
            font-weight: 600;
        }

        .status-value {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 12px;
            border-radius: 4px;
        }

        .status-ok {
            color: #10b981;
        }

        .status-error {
            color: #ef4444;
        }

        .status-warning {
            color: #f59e0b;
        }

        button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 4px;
        }

        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #60a5fa; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .queue-item {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .queue-item-failed {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ Payment System Diagnostics</h1>

        <!-- PayPal SDK Status -->
        <div class="section">
            <h2>üîß PayPal SDK Status</h2>
            <div class="status-item">
                <span class="status-label">SDK Loaded:</span>
                <span class="status-value" id="sdk-loaded">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Buttons API:</span>
                <span class="status-value" id="sdk-buttons">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Load Attempts:</span>
                <span class="status-value" id="sdk-attempts">0</span>
            </div>
            <div class="button-group">
                <button onclick="testPayPalSDK()">üîÑ Reload SDK</button>
                <button onclick="testPayPalButton()">üß™ Test Button Render</button>
            </div>
        </div>

        <!-- Balance & Auth Status -->
        <div class="section">
            <h2>üë§ User Status</h2>
            <div class="status-item">
                <span class="status-label">Authenticated:</span>
                <span class="status-value" id="auth-status">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Current Balance:</span>
                <span class="status-value" id="current-balance">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Last Updated:</span>
                <span class="status-value" id="balance-timestamp">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Username:</span>
                <span class="status-value" id="username">Checking...</span>
            </div>
        </div>

        <!-- Pending Purchases Queue -->
        <div class="section">
            <h2>üì¶ Pending PayPal Purchases</h2>
            <div id="pending-purchases">Loading...</div>
            <div class="button-group">
                <button onclick="retryPendingPurchases()">üîÑ Retry All Pending</button>
                <button onclick="clearPendingPurchases()">üóëÔ∏è Clear Queue</button>
            </div>
        </div>

        <!-- Failed Syncs -->
        <div class="section">
            <h2>‚ùå Failed Syncs</h2>
            <div id="failed-syncs">Loading...</div>
            <div class="button-group">
                <button onclick="retryFailedSyncs()">üîÑ Retry Failed Syncs</button>
                <button onclick="clearFailedSyncs()">üóëÔ∏è Clear Failed Queue</button>
            </div>
        </div>

        <!-- Pending Subscriptions -->
        <div class="section">
            <h2>üëë Pending VIP Subscriptions</h2>
            <div id="pending-subscriptions">Loading...</div>
            <div class="button-group">
                <button onclick="retryPendingSubscriptions()">üîÑ Retry Subscriptions</button>
                <button onclick="clearPendingSubscriptions()">üóëÔ∏è Clear Queue</button>
            </div>
        </div>

        <!-- Test Actions -->
        <div class="section">
            <h2>üß™ Test Actions</h2>
            <div class="button-group">
                <button onclick="simulatePurchase()">üí∞ Simulate $4.99 Purchase</button>
                <button onclick="simulateSubscription()">üëë Simulate VIP Subscription</button>
                <button onclick="testBackendSync()">üîÑ Test Backend Sync</button>
                <button onclick="testBalanceProtection()">üõ°Ô∏è Test Balance Protection</button>
                <button onclick="exportDiagnostics()">üì• Export Diagnostics</button>
            </div>
        </div>

        <!-- Console Log -->
        <div class="section">
            <h2>üìù Diagnostic Log</h2>
            <div class="log-container" id="log-container"></div>
            <div class="button-group">
                <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
            </div>
        </div>
    </div>

    <script>
        // Logging system
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }

        // Check PayPal SDK
        function checkPayPalSDK() {
            const sdkLoaded = typeof window.paypal !== 'undefined';
            const buttonsAPI = sdkLoaded && typeof window.paypal.Buttons === 'function';
            const attempts = window.paypalLoadAttempts || 0;

            document.getElementById('sdk-loaded').textContent = sdkLoaded ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('sdk-loaded').className = 'status-value ' + (sdkLoaded ? 'status-ok' : 'status-error');
            
            document.getElementById('sdk-buttons').textContent = buttonsAPI ? '‚úÖ Available' : '‚ùå Not Available';
            document.getElementById('sdk-buttons').className = 'status-value ' + (buttonsAPI ? 'status-ok' : 'status-error');
            
            document.getElementById('sdk-attempts').textContent = attempts;

            log(`PayPal SDK Status: ${sdkLoaded ? 'Loaded' : 'Not Loaded'}`, sdkLoaded ? 'success' : 'error');
            
            return { sdkLoaded, buttonsAPI, attempts };
        }

        // Check user status
        function checkUserStatus() {
            const token = localStorage.getItem('auth_token');
            const balance = localStorage.getItem('unified_balance') || '0';
            const timestamp = localStorage.getItem('balance_last_updated') || '0';
            const username = localStorage.getItem('unified_username') || 'Guest';
            
            const isAuth = !!token;
            const timeAgo = timestamp ? Math.floor((Date.now() - parseInt(timestamp)) / 1000) + 's ago' : 'Never';

            document.getElementById('auth-status').textContent = isAuth ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('auth-status').className = 'status-value ' + (isAuth ? 'status-ok' : 'status-error');
            
            document.getElementById('current-balance').textContent = parseInt(balance).toLocaleString();
            document.getElementById('balance-timestamp').textContent = timeAgo;
            document.getElementById('username').textContent = username;

            log(`User: ${username}, Balance: ${balance}, Auth: ${isAuth}`, 'info');
        }

        // Check pending purchases
        function checkPendingPurchases() {
            const pending = JSON.parse(localStorage.getItem('pending_paypal_purchases') || '[]');
            const container = document.getElementById('pending-purchases');

            if (pending.length === 0) {
                container.innerHTML = '<div class="status-item"><span class="status-ok">‚úÖ No pending purchases</span></div>';
            } else {
                container.innerHTML = pending.map(p => `
                    <div class="queue-item">
                        <strong>${p.bundleName}</strong>: ${p.coins.toLocaleString()} coins<br>
                        <small>Transaction ID: ${p.transactionId}</small><br>
                        <small>Timestamp: ${new Date(p.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
            }

            log(`Pending purchases: ${pending.length}`, pending.length > 0 ? 'warning' : 'success');
        }

        // Check failed syncs
        function checkFailedSyncs() {
            const failed = JSON.parse(localStorage.getItem('failed_paypal_syncs') || '[]');
            const container = document.getElementById('failed-syncs');

            if (failed.length === 0) {
                container.innerHTML = '<div class="status-item"><span class="status-ok">‚úÖ No failed syncs</span></div>';
            } else {
                container.innerHTML = failed.map(f => `
                    <div class="queue-item queue-item-failed">
                        <strong>${f.bundleName}</strong>: ${f.coins.toLocaleString()} coins<br>
                        <small>Transaction ID: ${f.transactionId}</small><br>
                        <small>Attempts: ${f.attempts || 1}</small><br>
                        <small>Timestamp: ${new Date(f.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
            }

            log(`Failed syncs: ${failed.length}`, failed.length > 0 ? 'error' : 'success');
        }

        // Check pending subscriptions
        function checkPendingSubscriptions() {
            const pending = JSON.parse(localStorage.getItem('pending_vip_subscriptions') || '[]');
            const container = document.getElementById('pending-subscriptions');

            if (pending.length === 0) {
                container.innerHTML = '<div class="status-item"><span class="status-ok">‚úÖ No pending subscriptions</span></div>';
            } else {
                container.innerHTML = pending.map(s => `
                    <div class="queue-item">
                        <strong>${s.subscriptionData.tier}</strong><br>
                        <small>Monthly Coins: ${s.subscriptionData.monthlyCoins.toLocaleString()}</small><br>
                        <small>Subscription ID: ${s.subscriptionData.subscriptionId}</small><br>
                        <small>Timestamp: ${new Date(s.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
            }

            log(`Pending subscriptions: ${pending.length}`, pending.length > 0 ? 'warning' : 'success');
        }

        // Test actions
        function testPayPalSDK() {
            log('Testing PayPal SDK reload...', 'info');
            location.reload();
        }

        function testPayPalButton() {
            if (typeof window.paypal === 'undefined') {
                log('PayPal SDK not loaded - cannot test button', 'error');
                alert('PayPal SDK not loaded. Please refresh the page.');
                return;
            }

            log('Rendering test PayPal button...', 'info');
            // Implementation would create a test button
            alert('PayPal SDK is working! Check console for details.');
        }

        function simulatePurchase() {
            const coins = 10000;
            const bundleName = 'TEST Starter Pack';
            const transactionId = 'TEST-' + Date.now();

            const pending = JSON.parse(localStorage.getItem('pending_paypal_purchases') || '[]');
            pending.push({ coins, bundleName, transactionId, timestamp: Date.now() });
            localStorage.setItem('pending_paypal_purchases', JSON.stringify(pending));

            const balance = parseInt(localStorage.getItem('unified_balance') || '0');
            localStorage.setItem('unified_balance', (balance + coins).toString());
            localStorage.setItem('balance_last_updated', Date.now().toString());

            log(`Simulated purchase: ${coins} coins (${bundleName})`, 'success');
            refreshAll();
        }

        function simulateSubscription() {
            const subscriptionData = {
                tier: 'TEST Silver VIP',
                tierId: 'test_silver',
                monthlyCoins: 15000,
                subscriptionId: 'TEST-SUB-' + Date.now(),
                timestamp: Date.now()
            };

            const pending = JSON.parse(localStorage.getItem('pending_vip_subscriptions') || '[]');
            pending.push({ subscriptionData, tier: { name: 'TEST Silver VIP' }, timestamp: Date.now() });
            localStorage.setItem('pending_vip_subscriptions', JSON.stringify(pending));

            log(`Simulated VIP subscription: ${subscriptionData.tier}`, 'success');
            refreshAll();
        }

        function testBackendSync() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                log('Cannot test backend sync - not authenticated', 'error');
                alert('Please login first to test backend sync');
                return;
            }

            log('Testing backend sync...', 'info');
            if (window.globalState && typeof window.globalState.retryPendingPurchases === 'function') {
                window.globalState.retryPendingPurchases();
                log('Backend sync triggered', 'success');
            } else {
                log('Global state not available', 'error');
            }
        }

        function testBalanceProtection() {
            const lastUpdate = Date.now();
            localStorage.setItem('balance_last_updated', lastUpdate.toString());
            
            const timeSince = 0; // Immediately
            const protected = timeSince < 60000; // 60 second window

            log(`Balance protection: ${protected ? 'ACTIVE' : 'INACTIVE'} (updated ${timeSince}ms ago)`, protected ? 'success' : 'warning');
            alert(`Balance protection is ${protected ? 'ACTIVE ‚úÖ' : 'INACTIVE ‚ö†Ô∏è'}\n\nLocal balance will ${protected ? 'be preserved' : 'sync from backend'} on next sync.`);
        }

        function retryPendingPurchases() {
            log('Retrying pending purchases...', 'info');
            if (window.globalState && typeof window.globalState.retryPendingPurchases === 'function') {
                window.globalState.retryPendingPurchases();
                log('Retry triggered', 'success');
                setTimeout(refreshAll, 2000);
            } else {
                log('Global state not available', 'error');
            }
        }

        function retryFailedSyncs() {
            log('Retrying failed syncs...', 'info');
            const failed = JSON.parse(localStorage.getItem('failed_paypal_syncs') || '[]');
            
            if (failed.length === 0) {
                log('No failed syncs to retry', 'warning');
                return;
            }

            if (window.globalState) {
                failed.forEach(sync => {
                    window.globalState.syncPayPalPurchaseToBackend(sync.coins, sync.bundleName, sync.transactionId);
                });
                log(`Retrying ${failed.length} failed syncs`, 'success');
                setTimeout(refreshAll, 2000);
            } else {
                log('Global state not available', 'error');
            }
        }

        function retryPendingSubscriptions() {
            log('Retrying pending subscriptions...', 'info');
            if (window.globalState && typeof window.globalState.retryPendingPurchases === 'function') {
                window.globalState.retryPendingPurchases();
                log('Retry triggered', 'success');
                setTimeout(refreshAll, 2000);
            } else {
                log('Global state not available', 'error');
            }
        }

        function clearPendingPurchases() {
            if (confirm('Clear all pending purchases? This cannot be undone!')) {
                localStorage.setItem('pending_paypal_purchases', '[]');
                log('Pending purchases cleared', 'warning');
                refreshAll();
            }
        }

        function clearFailedSyncs() {
            if (confirm('Clear all failed syncs? This cannot be undone!')) {
                localStorage.setItem('failed_paypal_syncs', '[]');
                log('Failed syncs cleared', 'warning');
                refreshAll();
            }
        }

        function clearPendingSubscriptions() {
            if (confirm('Clear all pending subscriptions? This cannot be undone!')) {
                localStorage.setItem('pending_vip_subscriptions', '[]');
                log('Pending subscriptions cleared', 'warning');
                refreshAll();
            }
        }

        function exportDiagnostics() {
            const data = {
                timestamp: new Date().toISOString(),
                paypalSDK: checkPayPalSDK(),
                auth: {
                    authenticated: !!localStorage.getItem('auth_token'),
                    username: localStorage.getItem('unified_username')
                },
                balance: {
                    current: localStorage.getItem('unified_balance'),
                    lastUpdated: localStorage.getItem('balance_last_updated')
                },
                pendingPurchases: JSON.parse(localStorage.getItem('pending_paypal_purchases') || '[]'),
                failedSyncs: JSON.parse(localStorage.getItem('failed_paypal_syncs') || '[]'),
                pendingSubscriptions: JSON.parse(localStorage.getItem('pending_vip_subscriptions') || '[]')
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payment-diagnostics-${Date.now()}.json`;
            a.click();

            log('Diagnostics exported to JSON file', 'success');
        }

        function refreshAll() {
            checkPayPalSDK();
            checkUserStatus();
            checkPendingPurchases();
            checkFailedSyncs();
            checkPendingSubscriptions();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Payment Diagnostics Tool initialized', 'success');
            refreshAll();
            
            // Auto-refresh every 5 seconds
            setInterval(refreshAll, 5000);
        });
    </script>
</body>
</html>
