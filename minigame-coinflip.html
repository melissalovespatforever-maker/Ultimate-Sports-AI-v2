<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Horse Racing ‚Äì Sprite Animated</title>
<style>
  body {
    background:#0f0f0f;
    color:white;
    font-family:Arial;
    text-align:center;
  }
  canvas {
    display:block;
    margin:20px auto;
    border:3px solid #333;
    background:black;
  }
  .panel {
    background:#1c1c1c;
    width:320px;
    margin:auto;
    padding:12px;
    border-radius:10px;
  }
</style>
</head>
<body>

<h2>üèá Horse Racing (Sprite Animated)</h2>

<canvas id="game" width="900" height="340"></canvas>

<div class="panel">
  üí∞ Balance: <span id="balance">1000</span><br>
  Horse:
  <select id="pick"></select><br>
  Bet:
  <input id="bet" type="number" value="100"><br>
  <button onclick="startRace()">Start Race</button>
</div>

<div id="result"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const FRAME_WIDTH = 128;   // width of one sprite frame
const FRAME_HEIGHT = 64;
const FRAMES = 4;          // frames per horse

let balance = 1000;
let racing = false;

const track = new Image();
track.src = "/horse-race/track.png";

const horses = [];
const lanes = [50, 105, 160, 215, 270];
const FINISH_X = canvas.width - 140;

// ---------- INIT ----------
function init() {
  horses.length = 0;

  for (let i = 1; i <= 5; i++) {
    const img = new Image();
    img.src = `/horse-race/horse${i}.png`;

    horses.push({
      name: `Horse ${i}`,
      img,
      x: 40,
      y: lanes[i - 1],
      speed: Math.random() * 1.4 + 2,
      stamina: Math.random() * 250 + 250,
      frame: 0,
      frameTick: 0,
      finished: false
    });
  }

  const sel = document.getElementById("pick");
  sel.innerHTML = "";
  horses.forEach((h, i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = h.name;
    sel.appendChild(o);
  });
}

// ---------- DRAW ----------
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(track, 0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "white";
  ctx.fillRect(FINISH_X, 0, 6, canvas.height);

  horses.forEach(h => {
    ctx.drawImage(
      h.img,
      h.frame * FRAME_WIDTH,
      0,
      FRAME_WIDTH,
      FRAME_HEIGHT,
      h.x,
      h.y,
      90,
      45
    );
  });
}

// ---------- RACE ----------
function startRace() {
  if (racing) return;

  const bet = Number(document.getElementById("bet").value);
  if (bet <= 0 || bet > balance) return alert("Invalid bet");

  balance -= bet;
  document.getElementById("balance").textContent = balance;

  racing = true;
  document.getElementById("result").innerHTML = "";
  requestAnimationFrame(() => raceLoop(bet));
}

function raceLoop(bet) {
  draw();

  let winner = null;

  horses.forEach(h => {
    if (h.finished) return;

    // movement
    let move = h.speed;
    h.stamina--;
    if (h.stamina < 120) move *= 0.6;
    if (Math.random() < 0.04) move += 1.4;

    h.x += move;

    // animation
    h.frameTick++;
    if (h.frameTick > 6) {
      h.frame = (h.frame + 1) % FRAMES;
      h.frameTick = 0;
    }

    if (h.x >= FINISH_X) {
      h.finished = true;
      if (!winner) winner = h;
    }
  });

  if (winner) {
    finishRace(winner, bet);
    return;
  }

  requestAnimationFrame(() => raceLoop(bet));
}

// ---------- FINISH ----------
function finishRace(winner, bet) {
  racing = false;
  const pick = document.getElementById("pick").value;

  let msg = `üèÜ Winner: ${winner.name}<br>`;

  if (horses[pick] === winner) {
    const payout = bet * 2;
    balance += payout;
    msg += `You won $${payout}`;
  } else {
    msg += "You lost the bet";
  }

  document.getElementById("balance").textContent = balance;
  document.getElementById("result").innerHTML = msg;

  init();
}

// ---------- START ----------
track.onload = () => {
  init();
  draw();
};
</script>

</body>
</html>
