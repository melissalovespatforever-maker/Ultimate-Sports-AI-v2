<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>2D Horse Racing Simulator</title>
<style>
  body { background:#111; color:#fff; font-family:Arial; text-align:center; }
  canvas { background:#000; display:block; margin:15px auto; border:3px solid #444; }
  .ui { background:#222; width:360px; margin:auto; padding:12px; border-radius:8px; }
  button, select, input { margin-top:6px; padding:6px; }
</style>
</head>
<body>

<h2>ğŸ‡ Horse Racing</h2>

<canvas id="game" width="900" height="360"></canvas>

<div class="ui">
  ğŸ’° Balance: <span id="money">1000</span><br>

  Horse:
  <select id="horsePick"></select><br>

  Bet:
  <input type="number" id="bet" value="100" min="10"><br>

  <button onclick="startRace()">Start Race</button>
</div>

<div id="result"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let balance = 1000; // ğŸ”Œ replace later with app currency
let racing = false;
let winnerDeclared = false;

const trackImg = new Image();
trackImg.src = "track.png";

const horses = [];

function loadHorses() {
  horses.length = 0;
  for (let i = 0; i < 5; i++) {
    const img = new Image();
    img.src = `horses/horse${i+1}.png`;

    horses.push({
      name: `Horse ${i+1}`,
      img,
      x: 30,
      y: 60 + i * 55,
      speed: Math.random() * 1.2 + 1.8,
      stamina: Math.random() * 300 + 300,
      burst: Math.random() * 0.8,
      consistency: Math.random(),
      finished: false
    });
  }
}

function populateDropdown() {
  const sel = document.getElementById("horsePick");
  sel.innerHTML = "";
  horses.forEach((h, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = `${h.name}`;
    sel.appendChild(opt);
  });
}

function drawScene() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(trackImg, 0, 0, canvas.width, canvas.height);

  // Finish line
  ctx.fillStyle = "#fff";
  ctx.fillRect(canvas.width - 100, 0, 6, canvas.height);

  horses.forEach(h => {
    ctx.drawImage(h.img, h.x, h.y, 80, 40);
  });
}

function startRace() {
  if (racing) return;

  const bet = Number(document.getElementById("bet").value);
  if (bet > balance || bet <= 0) return alert("Invalid bet");

  balance -= bet;
  updateMoney();

  racing = true;
  winnerDeclared = false;
  document.getElementById("result").innerHTML = "";

  loadHorses();
  populateDropdown();
  requestAnimationFrame(() => raceLoop(bet));
}

function raceLoop(bet) {
  drawScene();

  let winner = null;

  horses.forEach(h => {
    if (h.finished) return;

    let move = h.speed;

    // stamina drain
    h.stamina -= 1;

    if (h.stamina < 150) move *= 0.6;

    // random burst
    if (Math.random() < h.consistency) {
      move += h.burst;
    }

    h.x += move;

    if (h.x >= canvas.width - 130) {
      h.finished = true;
      if (!winner) winner = h;
    }
  });

  if (winner && !winnerDeclared) {
    winnerDeclared = true;
    finishRace(winner, bet);
  }

  if (!winnerDeclared) {
    requestAnimationFrame(() => raceLoop(bet));
  }
}

function finishRace(winner, bet) {
  const pick = document.getElementById("horsePick").value;
  let text = `ğŸ† Winner: ${winner.name}<br>`;

  if (horses[pick] === winner) {
    const payout = bet * 2;
    balance += payout;
    text += `You won $${payout}`;
  } else {
    text += "You lost the race";
  }

  updateMoney();
  document.getElementById("result").innerHTML = text;
}

function updateMoney() {
  document.getElementById("money").textContent = balance;
}

trackImg.onload = () => {
  loadHorses();
  populateDropdown();
  drawScene();
};
</script>

</body>
</html>
